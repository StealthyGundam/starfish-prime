<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RobCo Terminal Cipher Grid</title>
<style>
html, body {
  margin:0; padding:20px;
  width:100%; height:100%;
  font-family:'Courier New', monospace;
  background:#010; color:#0f0;
  overflow-y:auto; overflow-x:hidden;
  line-height:1.2;
  user-select:none;
}

/* CRT text glow/flicker */
.terminal-line {
  display:block;
  color:#0f0;
  text-shadow:0 0 2px #0f0,0 0 4px #0f0;
  white-space:pre-wrap;
  animation: flicker 2s infinite alternate;
}

/* Grid wrapper */
.grid-wrapper { display:flex; justify-content:center; align-items:flex-start; padding:10px; position:relative; overflow:hidden; opacity:0; transition:opacity 0.5s; margin-top:20px; }
.grid-wrapper::before { content:""; position:absolute; top:0; left:0; width:100%; height:100%; background: repeating-linear-gradient(to bottom, rgba(0,0,0,0) 0px, rgba(0,0,0,0.08) 1px); pointer-events:none; z-index:2; }
.grid-wrapper::after { content:""; position:absolute; top:0; left:0; width:100%; height:100%; background: radial-gradient(circle at center, rgba(0,255,0,0.05) 0%, transparent 80%); pointer-events:none; z-index:1; animation: pulseGlow 3s infinite alternate; }

/* Grid */
.grid { display:grid; grid-template-columns:repeat(20,1fr); grid-template-rows:repeat(20,1fr); width:100%; max-width:90vmin; aspect-ratio:1/1; z-index:3; position:relative; }
.cell { display:flex; align-items:center; justify-content:center; font-size:clamp(10px,2vw,18px); line-height:1; color:#0f0; text-shadow:0 0 2px #0f0,0 0 4px #0f0; animation: flicker 2s infinite alternate; }
.solved .cell { color:#0ff; text-shadow:0 0 6px #0ff,0 0 12px #0ff; }
.cell.glitch { animation: glitchFlicker 0.2s infinite; }

@keyframes flicker { 0%,19%,21%,23%,25%,54%,56%,100%{opacity:1;} 20%,22%,24%,55%{opacity:0.5;} }
@keyframes glitchFlicker {0%,50%,100%{opacity:1;} 25%,75%{opacity:0;}}
@keyframes pulseGlow {0%{opacity:0.03;}50%{opacity:0.08;}100%{opacity:0.03;}}
</style>
</head>
<body>

<div id="terminal"></div>

<div class="grid-wrapper">
  <div id="grid" class="grid"></div>
</div>

<script>
// Cipher setup
const PRIME_KEY=23n, MOD=29n;
const BASE_ALPHABET=[..."ABCDEFGHIJKLMNOPQRSTUVWXYZ ,."];
const CIPHER_TEXT="TGVN,XOWVTHNVA, SDV IGFV OGVNT X,EGFVLSOWNVEHMVHOVPTGVM  O,HWTP.VSVBS,SEHOVISMBHFGVTGVRS,DGEVRHPTV SPTVSOEVTXOWGFVUS,SOAGEVUZVLSHPT.VPTGVAHPZVDOGRVTHNVIHWH,VSOEVLG,PVNSLGFVSPVOHWTP.VGMBPZVNPFGGPNVNHWTGEVSNVTGVEGBSFPGEVP VNGFIGVSVYXHGPVAS,,V LVEXPZ.VS,,GZNVFGMGMUGFGEVTHNVNMH,GVTHNVMGFAZVTHNVNPGG,VFGN I,G.VL FVO RVTGVRSNVW OGVUXPVTHNVBF MHNGVFGMSHOGE.VPTGVM  OVRHPOGNNVSOEVU,GNNGEVTHNVFHWTPG XNVBSPT.";
const CORRECT_KEYWORD="SUNBLOCKER";
const CORRECT_KEY=(function(){let a=23n,m=28n,t,q,x0=0n,x1=1n;while(a>1n){q=a/m;t=m;m=a%m;a=t;t=x0;x0=x1-q*x0;x1=t;}if(x1<0n)x1+=m;return x1;})();

const terminal=document.getElementById("terminal");
const grid=document.getElementById("grid");

// Precreate 400 grid cells
const cells=[];
for(let i=0;i<400;i++){let c=document.createElement("div");c.className="cell";c.textContent=" ";grid.appendChild(c);cells.push(c);}

// Render grid
function renderGrid(chars){
  for(let i=0;i<400;i++) cells[i].textContent=chars[i]||' ';
}

// Update function
function update(){
  const keyLine=document.getElementById("key-line");
  const keywordLine=document.getElementById("keyword-line");
  if(!keyLine || !keywordLine) return;

  const keyVal = Array.from(keyLine.querySelectorAll('.input-char')).map(s=>s.textContent||'0').join('');
  const kwVal = Array.from(keywordLine.querySelectorAll('.input-char')).map(s=>s.textContent||'').join('');

  const keyV = keyVal ? BigInt(keyVal) : 0n;
  const kw = kwVal.toUpperCase().split("").filter(c=>BASE_ALPHABET.includes(c));
  const seen = new Set();
  const keyChars = kw.filter(c=>{ if(seen.has(c)) return false; seen.add(c); return true; });
  const remainder = BASE_ALPHABET.filter(c=>!keyChars.includes(c));
  const cipherAlphabet = [...keyChars, ...remainder];

  const output = [];
  for(const char of CIPHER_TEXT){
    const idx = cipherAlphabet.indexOf(char);
    if(idx===-1){ output.push(char); continue; }
    const decIdx = Number((BigInt(idx) ** keyV) % MOD);
    output.push(BASE_ALPHABET[decIdx] || char);
  }

  renderGrid(output);
}

// Boot sequence text
const bootLines=[
  "ROBOCO INDUSTRIES UNIFIED OPERATING SYSTEM",
  "COPYRIGHT 2075-2077 ROBCO INDUSTRIES",
  "-RobCo Trespasser Management System-",
  "==========================",
  "| User Log:",
  "| >> Enter Decryption Key: ■■■",
  "| >> Enter Keyword: ■■■■■■■■■■",
  "==========================",
  "> run:// search -locked terminal",
  "> LOG: Please enter correct decryption key and keyword for access..."
];

// Type boot line by line
async function typeBootLine(line){
  return new Promise(res=>{
    const span=document.createElement("span");
    span.className="terminal-line";
    terminal.appendChild(span);
    let i=0;
    const interval=setInterval(()=>{
      span.textContent += line[i];
      i++;
      if(i>=line.length){ clearInterval(interval); res(); }
    },50);
  });
}

// Enable inline typing placeholders
function enableTypingPlaceholders(){
  const lines = terminal.querySelectorAll('.terminal-line');
  lines.forEach(line=>{
    if(line.textContent.includes('Enter Decryption Key: ■')) {
      const text = line.textContent;
      const parts = text.split('■');
      line.innerHTML = parts.map((p,i)=> i===0?p:`<span class="input-char" contenteditable="true"></span>`).join('');
      line.id='key-line';
      line.querySelectorAll('.input-char').forEach(span=>{
        span.addEventListener('input', update);
        span.addEventListener('keydown', e=>{
          if(e.key.length===1 && e.target.textContent.length>0) e.preventDefault();
        });
      });
    }
    if(line.textContent.includes('Enter Keyword: ■')) {
      const text = line.textContent;
      const parts = text.split('■');
      line.innerHTML = parts.map((p,i)=> i===0?p:`<span class="input-char" contenteditable="true"></span>`).join('');
      line.id='keyword-line';
      line.querySelectorAll('.input-char').forEach(span=>{
        span.addEventListener('input', update);
        span.addEventListener('keydown', e=>{
          if(e.key.length===1 && e.target.textContent.length>0) e.preventDefault();
        });
      });
    }
  });
  document.querySelector(".grid-wrapper").style.opacity="1";
}

// Run boot
async function runBoot(){
  for(const line of bootLines) await typeBootLine(line);
  enableTypingPlaceholders();
}

runBoot();
</script>
</body>
</html>
